<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½è³å¨æ±€æ°´å°</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f5f5f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* åŠ è½½é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #666; font-size: 0.9rem; }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin: 10px 0 20px 0;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .version-tag {
            font-size: 0.8rem;
            background: #e9ecef;
            color: #6c757d;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .form-group { margin-bottom: 12px; }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .form-label {
            width: 90px;
            text-align: right;
            margin-right: 10px;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 150px;
        }

        .name-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }
        .name-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        .size-btn {
            width: 32px; height: 38px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            flex-shrink: 0;
        }
        .size-btn:active { background: #e2e6ea; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 1rem;
            flex: 1;
            text-align: center;
            font-weight: 500;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .photo-btn-fixed {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 150px;
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; align-items: stretch; gap: 5px; }
            .form-label { width: 100%; text-align: left; margin-bottom: 2px; font-weight: bold;}
            .form-input, .name-input-group { width: 100%; box-sizing: border-box; }
            .btn { width: 100%; margin-right: 0; }
            .controls-wrapper { flex-direction: row !important; }
            .control-group { width: 48% !important; padding: 10px; }
            .export-content { display: flex; flex-direction: row; gap: 15px; flex-wrap: wrap; }
            .export-content > div { flex: 1; min-width: 140px; }
        }

        .preview-container {
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 15px;
            text-align: center;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-image { max-width: 100%; height: auto; display: block; }

        .controls-wrapper {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        .control-group {
            flex: 1;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            display: block;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .control-title {
            margin: 0;
            font-size: 0.95rem;
            color: #444;
            font-weight: bold;
        }
        .control-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn {
            background: none; border: 1px solid #ddd; border-radius: 4px;
            width: 26px; height: 26px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 16px; color: #555; padding: 0;
        }
        .icon-btn:hover { background: #f1f1f1; }
        .icon-btn.reset-btn { color: #007bff; border-color: #007bff; }
        
        .control-content { transition: all 0.3s ease; }
        .control-content.collapsed { display: none; }

        .slider-group { margin-bottom: 12px; }
        .slider-label-top {
            display: block;
            text-align: left;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .slider-wrapper { width: 100%; margin: 0; }
        input[type=range] { width: 100%; height: 24px; }

        .export-options {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .export-title { margin: 0; font-size: 1rem; color: #444; font-weight: bold; }
        .export-content { transition: all 0.3s ease; }
        .export-content.collapsed { display: none; }
        
        .export-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .export-item { flex: 1; min-width: 200px; }
        .export-item label { font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }

        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; font-size: 0.9rem; white-space: nowrap; }
        .radio-item input { margin-right: 4px; transform: scale(1.1); }
        
        .file-info { margin-left: 10px; color: #666; font-size: 0.9rem; word-break: break-all; line-height: 40px; }
        .hidden { display: none; }
        .size-display { font-size: 0.8rem; color: #666; width: 35px; text-align: center; flex-shrink: 0; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½èµ„æº...</div>
    </div>

    <div class="container">
        <h1>
            å¥½è³å¨æ±€æ°´å° 
            <span class="version-tag">v1.0</span>
        </h1>
        
        <div class="form-group">
            <div class="form-row">
                <label class="form-label">å…æ—¶æ®µ:</label>
                <input type="text" id="timeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¥¥æ–¯å¡æ™šå®´">
                <label class="form-label" style="margin-left: 10px;">å®´å¸­ç±»å‹:</label>
                <input type="text" id="typeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå©šå®´">
            </div>
            
            <div class="form-row">
                <label class="form-label">æ–°éƒå§“å:</label>
                <div class="name-input-group">
                    <input type="text" id="groomInput" class="name-input" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
                    <div class="size-btn" id="groomMinus">âˆ’</div>
                    <div class="size-display" id="groomSizeDisplay">100%</div>
                    <div class="size-btn" id="groomPlus">+</div>
                </div>
            </div>
            
            <div class="form-row">
                <label class="form-label">æ–°å¨˜å§“å:</label>
                <div class="name-input-group">
                    <input type="text" id="brideInput" class="name-input" placeholder="ä¾‹å¦‚ï¼šæå››">
                    <div class="size-btn" id="brideMinus">âˆ’</div>
                    <div class="size-display" id="brideSizeDisplay">100%</div>
                    <div class="size-btn" id="bridePlus">+</div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="form-row" style="flex-direction: row; align-items: center;">
                <button id="photoBtn" class="btn btn-primary photo-btn-fixed">ğŸ–¼ï¸ é€‰å›¾</button>
                <span id="photoInfo" class="file-info">æœªé€‰æ‹©</span>
                <input type="file" id="photoFile" accept="image/*" class="hidden">
            </div>
        </div>

        <div class="controls-wrapper">
            <div id="cropControls" class="control-group">
                <div class="control-header">
                    <h4 class="control-title">ğŸ“· å›¾ç‰‡ä½ç½®</h4>
                    <div class="control-actions">
                        <button class="icon-btn reset-btn" id="resetCropBtn" title="é‡ç½®">ğŸ”„</button>
                        <button class="icon-btn" id="toggleCropBtn" title="å±•å¼€/æŠ˜å ">+</button>
                    </div>
                </div>
                <div class="control-content collapsed" id="cropContent">
                    <div class="slider-group">
                        <label class="slider-label-top">å·¦å³</label>
                        <div class="slider-wrapper"><input type="range" id="hSlider" min="-500" max="500" value="0" step="25"></div>
                    </div>
                    <div class="slider-group">
                        <label class="slider-label-top">ä¸Šä¸‹</label>
                        <div class="slider-wrapper"><input type="range" id="vSlider" min="-500" max="500" value="0" step="25"></div>
                    </div>
                </div>
            </div>

            <div id="nameControls" class="control-group" style="display:none;">
                <div class="control-header">
                    <h4 class="control-title">âœï¸ å§“åä½ç½®</h4>
                    <div class="control-actions">
                        <button class="icon-btn reset-btn" id="resetNameBtn" title="é‡ç½®">ğŸ”„</button>
                        <button class="icon-btn" id="toggleNameBtn" title="å±•å¼€/æŠ˜å ">+</button>
                    </div>
                </div>
                <div class="control-content collapsed" id="nameContent">
                    <div class="slider-group">
                        <label class="slider-label-top">å·¦å³</label>
                        <div class="slider-wrapper"><input type="range" id="nameHSlider" min="-1000" max="1000" value="0" step="10"></div>
                    </div>
                    <div class="slider-group">
                        <label class="slider-label-top">ä¸Šä¸‹</label>
                        <div class="slider-wrapper"><input type="range" id="nameVSlider" min="-1000" max="1000" value="0" step="10"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="preview-container">
            <canvas id="previewCanvas" class="preview-image"></canvas>
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <button id="refreshBtn" class="btn btn-warning">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
        </div>

        <div class="export-options">
            <div class="export-header">
                <h3 class="export-title">å¯¼å‡ºè®¾ç½®</h3>
                <button class="icon-btn" id="toggleExportBtn" title="å±•å¼€/æŠ˜å ">+</button>
            </div>
            <div class="export-content collapsed" id="exportContent">
                <div class="export-row">
                    <div class="export-item">
                        <label>åˆ†è¾¨ç‡:</label>
                        <div class="radio-group">
                            <label class="radio-item"><input type="radio" name="resolution" id="res4k" value="4k" checked> 4K</label>
                            <label class="radio-item"><input type="radio" name="resolution" id="res1k" value="1k"> 1080P</label>
                        </div>
                    </div>
                    <div class="export-item">
                        <label>æ ¼å¼:</label>
                        <div class="radio-group">
                            <label class="radio-item"><input type="radio" name="format" id="fmtJpg" value="jpg" checked> JPG</label>
                            <label class="radio-item"><input type="radio" name="format" id="fmtPng" value="png"> PNG</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button id="generateBtn" class="btn btn-success" style="font-size: 1.1rem; font-weight: bold;">ğŸ’¾ ç”Ÿæˆå¹¶ä¿å­˜å›¾ç‰‡</button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('âœ… SW OK:', reg.scope))
                    .catch(err => console.error('âŒ SW Fail:', err));
            });
        }
    </script>

    <script>
        // ================= é…ç½®åŒº =================
        const BACKGROUND_URL = "./back.png"; // âš ï¸ å»ºè®®æ”¹ä¸º back.webp ä»¥æé€Ÿ
        const FONT_URL = "./FZXiaoBiaoSong-B05S.woff2"; // âš ï¸ å»ºè®®æ”¹ä¸ºå­é›†åŒ–å­—ä½“
        const BASE_FONT_SIZE = 192;
        
        let userImageBase64 = null;
        let cropOffsetX = 0, cropOffsetY = 0;
        let nameOffsetX = 0, nameOffsetY = 0;
        let groomScale = 100, brideScale = 100;
        let customFontFamily = 'serif';
        let resourcesLoaded = false;
        let bgImageObj = null; // ç¼“å­˜èƒŒæ™¯å›¾å¯¹è±¡

        const elements = {
            timeInput: document.getElementById('timeInput'),
            typeInput: document.getElementById('typeInput'),
            groomInput: document.getElementById('groomInput'),
            brideInput: document.getElementById('brideInput'),
            photoBtn: document.getElementById('photoBtn'),
            photoFile: document.getElementById('photoFile'),
            photoInfo: document.getElementById('photoInfo'),
            cropControls: document.getElementById('cropControls'),
            cropContent: document.getElementById('cropContent'),
            toggleCropBtn: document.getElementById('toggleCropBtn'),
            resetCropBtn: document.getElementById('resetCropBtn'),
            hSlider: document.getElementById('hSlider'),
            vSlider: document.getElementById('vSlider'),
            nameControls: document.getElementById('nameControls'),
            nameContent: document.getElementById('nameContent'),
            toggleNameBtn: document.getElementById('toggleNameBtn'),
            resetNameBtn: document.getElementById('resetNameBtn'),
            nameHSlider: document.getElementById('nameHSlider'),
            nameVSlider: document.getElementById('nameVSlider'),
            toggleExportBtn: document.getElementById('toggleExportBtn'),
            exportContent: document.getElementById('exportContent'),
            previewCanvas: document.getElementById('previewCanvas'),
            refreshBtn: document.getElementById('refreshBtn'),
            res4k: document.getElementById('res4k'),
            res1k: document.getElementById('res1k'),
            fmtJpg: document.getElementById('fmtJpg'),
            fmtPng: document.getElementById('fmtPng'),
            generateBtn: document.getElementById('generateBtn'),
            groomMinus: document.getElementById('groomMinus'),
            groomPlus: document.getElementById('groomPlus'),
            groomSizeDisplay: document.getElementById('groomSizeDisplay'),
            brideMinus: document.getElementById('brideMinus'),
            bridePlus: document.getElementById('bridePlus'),
            brideSizeDisplay: document.getElementById('brideSizeDisplay'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        function initCollapsibles() {
            const setupToggle = (btn, content, defaultOpen = false) => {
                if (!defaultOpen) content.classList.add('collapsed');
                btn.textContent = defaultOpen ? 'âˆ’' : '+';
                btn.addEventListener('click', () => {
                    const isCollapsed = content.classList.contains('collapsed');
                    content.classList.toggle('collapsed');
                    btn.textContent = isCollapsed ? 'âˆ’' : '+';
                });
            };
            setupToggle(elements.toggleCropBtn, elements.cropContent, false);
            setupToggle(elements.toggleNameBtn, elements.nameContent, false);
            setupToggle(elements.toggleExportBtn, elements.exportContent, false);

            elements.resetCropBtn.addEventListener('click', () => {
                elements.hSlider.value = 0; elements.vSlider.value = 0;
                cropOffsetX = 0; cropOffsetY = 0; updatePreview();
            });
            elements.resetNameBtn.addEventListener('click', () => {
                elements.nameHSlider.value = 0; elements.nameVSlider.value = 0;
                nameOffsetX = 0; nameOffsetY = 0; updatePreview();
            });
        }

        // âš¡ï¸ ä¼˜åŒ–ï¼šå¹¶è¡ŒåŠ è½½èµ„æº
        async function preloadResources() {
            const loadFontPromise = (async () => {
                if (!FONT_URL) return 'serif';
                const fontName = 'FZXiaoBiaoSong';
                const style = document.createElement('style');
                style.textContent = `@font-face { font-family: "${fontName}"; src: url('${FONT_URL}') format("woff2"); }`;
                document.head.appendChild(style);
                try {
                    await document.fonts.load(`${BASE_FONT_SIZE}px "${fontName}"`);
                    return fontName;
                } catch (e) { return 'serif'; }
            })();

            const loadBgPromise = (async () => {
                const img = new Image();
                img.src = BACKGROUND_URL;
                img.crossOrigin = "Anonymous";
                return new Promise((resolve) => {
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                });
            })();

            // ç­‰å¾…ä¸¤è€…éƒ½å®Œæˆ (å¹¶è¡Œ)
            const [fontFamily, bgImg] = await Promise.all([loadFontPromise, loadBgPromise]);
            
            customFontFamily = fontFamily;
            bgImageObj = bgImg;
            resourcesLoaded = true;

            // éšè—é®ç½©
            if (elements.loadingOverlay) {
                elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => elements.loadingOverlay.style.display = 'none', 300);
            }
            
            // ç«‹å³è§¦å‘ä¸€æ¬¡é¢„è§ˆ
            updatePreview();
        }

        function initEventListeners() {
            initCollapsibles();
            elements.photoBtn.addEventListener('click', () => elements.photoFile.click());
            elements.photoFile.addEventListener('change', handlePhotoUpload);
            
            elements.hSlider.addEventListener('input', (e) => { cropOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.vSlider.addEventListener('input', (e) => { cropOffsetY = parseInt(e.target.value); updatePreview(); });
            elements.nameHSlider.addEventListener('input', (e) => { nameOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.nameVSlider.addEventListener('input', (e) => { nameOffsetY = parseInt(e.target.value); updatePreview(); });

            elements.groomPlus.addEventListener('click', () => { groomScale = Math.min(groomScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.groomMinus.addEventListener('click', () => { groomScale = Math.max(groomScale - 10, 20); updateSizeUI(); updatePreview(); });
            elements.bridePlus.addEventListener('click', () => { brideScale = Math.min(brideScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.brideMinus.addEventListener('click', () => { brideScale = Math.max(brideScale - 10, 20); updateSizeUI(); updatePreview(); });

            elements.refreshBtn.addEventListener('click', updatePreview);
            elements.generateBtn.addEventListener('click', generateImage);
            
            [elements.timeInput, elements.groomInput, elements.brideInput, elements.typeInput].forEach(input => {
                input.addEventListener('input', updatePreview);
            });
        }

        function updateSizeUI() {
            elements.groomSizeDisplay.textContent = groomScale + '%';
            elements.brideSizeDisplay.textContent = brideScale + '%';
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                userImageBase64 = e.target.result;
                elements.photoInfo.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                checkNameControls();
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function checkNameControls() {
            const hasName = elements.groomInput.value.trim() || elements.brideInput.value.trim();
            elements.nameControls.style.display = hasName ? 'block' : 'none';
        }

        function getResolution() {
            if (elements.res4k.checked) return { width: 3840, height: 2160 };
            return { width: 1920, height: 1080 };
        }

        function loadFont(size) { return `${size}px "${customFontFamily}"`; }

        function cropToTarget(img, targetW = 2544, targetH = 1760) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const ratio = targetW / targetH;
            const origRatio = img.width / img.height;
            let newW, newH;
            if (origRatio > ratio) { newH = targetH; newW = newH * origRatio; }
            else { newW = targetW; newH = newW / origRatio; }
            canvas.width = newW; canvas.height = newH;
            ctx.drawImage(img, 0, 0, newW, newH);
            let left = (newW - targetW) / 2;
            let top = (newH - targetH) / 2;
            left = Math.max(0, Math.min(left + cropOffsetX, newW - targetW));
            top = Math.max(0, Math.min(top + cropOffsetY, newH - targetH));
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = targetW; cropCanvas.height = targetH;
            cropCanvas.getContext('2d').drawImage(canvas, left, top, targetW, targetH, 0, 0, targetW, targetH);
            return cropCanvas;
        }

        function drawText(ctx, x, y, text, font, fill) {
            ctx.font = font; ctx.fillStyle = fill; ctx.fillText(text, x, y);
        }
        function drawBoldText(ctx, x, y, text, font, fill) {
            ctx.font = font; ctx.fillStyle = fill;
            [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dx,dy]) => ctx.fillText(text, x+dx, y+dy));
            ctx.fillText(text, x, y);
        }

        async function generateCompositeImage(isPreview = false) {
            const canvas = document.createElement('canvas');
            // âš¡ï¸ ä¼˜åŒ–ï¼šé¢„è§ˆæ¨¡å¼ä¸‹åŠ¨æ€é™ä½åˆ†è¾¨ç‡ï¼Œæå¤§æå‡é€Ÿåº¦
            let renderW = 3840, renderH = 2160;
            if (isPreview) {
                const containerW = elements.previewCanvas.parentElement.clientWidth;
                // é¢„è§ˆåªéœ€è¶³å¤Ÿæ¸…æ™°å³å¯ï¼Œä¸éœ€è¦ 4K
                renderW = Math.min(1920, containerW * 2); 
                renderH = Math.floor(renderW * (2160/3840));
            }

            canvas.width = renderW;
            canvas.height = renderH;
            const ctx = canvas.getContext('2d');
            const scaleX = renderW / 3840;
            const scaleY = renderH / 2160;

            // ç»˜åˆ¶èƒŒæ™¯ (å¦‚æœå·²åŠ è½½)
            if (bgImageObj) {
                ctx.drawImage(bgImageObj, 0, 0, renderW, renderH);
            } else {
                // æœªåŠ è½½æ—¶ç»˜åˆ¶ç°è‰²èƒŒæ™¯ï¼Œé˜²æ­¢ç™½å±
                ctx.fillStyle = "#ddd";
                ctx.fillRect(0, 0, renderW, renderH);
            }

            const hallTime = elements.timeInput.value.trim() || "ä»€ä¹ˆå…æ™šå®´";
            const groom = elements.groomInput.value.trim();
            const bride = elements.brideInput.value.trim();
            const weddingType = elements.typeInput.value.trim() || "æ²¡å†™å®´å¸­";
            const textColor = "rgba(120, 65, 25, 1)";

            // åæ ‡ç¼©æ”¾
            const baseX = (650 - 536) * scaleX; 
            const baseGroomY = (1110 + 158) * scaleY;
            const baseBrideY = (1380 + 158) * scaleY;
            const baseTimeX = 280 * scaleX, baseTimeY = (490 + 148) * scaleY;
            const baseTypeX = 3100 * scaleX, baseTypeY = (100 + 167) * scaleY;

            const finalX = baseX + (nameOffsetX * scaleX);
            let finalGroomY = baseGroomY + (nameOffsetY * scaleY);
            let finalBrideY = baseBrideY + (nameOffsetY * scaleY);

            if (groom && !bride) finalGroomY += 120 * scaleY;

            // å­—ä½“å¤§å°ç¼©æ”¾
            const fontSizeScale = scaleX; 
            if (hallTime) drawBoldText(ctx, baseTimeX, baseTimeY, hallTime, loadFont(166 * fontSizeScale), textColor);
            if (weddingType) drawText(ctx, baseTypeX, baseTypeY, weddingType, loadFont(220 * fontSizeScale), textColor);

            if (groom) drawText(ctx, finalX, finalGroomY, groom, loadFont(BASE_FONT_SIZE * (groomScale/100) * fontSizeScale), textColor);
            if (bride) drawText(ctx, finalX, finalBrideY, bride, loadFont(BASE_FONT_SIZE * (brideScale/100) * fontSizeScale), textColor);

            if (userImageBase64) {
                try {
                    const userImg = new Image();
                    userImg.src = userImageBase64;
                    await new Promise(r => { userImg.onload = r; });
                    const processedImg = cropToTarget(userImg, 2544, 1760);
                    // ç”¨æˆ·å›¾ç‰‡ä¹Ÿè¦ç¼©æ”¾
                    const uW = 2544 * scaleX;
                    const uH = 1760 * scaleY;
                    ctx.drawImage(processedImg, renderW - uW, renderH - uH, uW, uH);
                } catch (e) { console.error(e); }
            }

            // å¦‚æœæœ€ç»ˆéœ€è¦ç‰¹å®šåˆ†è¾¨ç‡ (ä»…å¯¼å‡ºæ—¶)
            if (!isPreview) {
                const targetRes = getResolution();
                if (targetRes.width !== renderW || targetRes.height !== renderH) {
                    const fC = document.createElement('canvas');
                    fC.width = targetRes.width; fC.height = targetRes.height;
                    fC.getContext('2d').drawImage(canvas, 0, 0, targetRes.width, targetRes.height);
                    return fC;
                }
            }
            return canvas;
        }

        async function updatePreview() {
            const pCtx = elements.previewCanvas.getContext('2d');
            const w = elements.previewCanvas.parentElement.clientWidth - 20;
            // å…ˆæ¸…ç©º
            elements.previewCanvas.width = w; 
            elements.previewCanvas.height = 200;
            pCtx.fillStyle = "#f0f0f0"; 
            pCtx.fillRect(0,0,w,200);
            
            if (!resourcesLoaded) {
                pCtx.fillStyle = "#999"; pCtx.font = "14px Arial"; pCtx.textAlign = "center";
                pCtx.fillText("èµ„æºåŠ è½½ä¸­...", w/2, 100);
                return;
            }

            try {
                const composite = await generateCompositeImage(true);
                const h = Math.floor(w * composite.height / composite.width);
                elements.previewCanvas.width = w; 
                elements.previewCanvas.height = h;
                pCtx.drawImage(composite, 0, 0, w, h);
                checkNameControls();
            } catch (e) {
                pCtx.fillStyle = "red"; pCtx.fillText("å‡ºé”™", w/2, 100);
            }
        }

        async function generateImage() {
            if (!resourcesLoaded) { alert("èµ„æºåŠ è½½ä¸­..."); return; }
            const oldTxt = elements.generateBtn.innerText;
            elements.generateBtn.innerText = "â³ ç”Ÿæˆä¸­...";
            elements.generateBtn.disabled = true;
            try {
                const composite = await generateCompositeImage(false);
                const fmt = elements.fmtJpg.checked ? 'image/jpeg' : 'image/png';
                composite.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const g = elements.groomInput.value.trim();
                    const b = elements.brideInput.value.trim();
                    let name = "wedding";
                    if (g && b) name = `${g} ${b}`;
                    else if (g) name = g;
                    else if (b) name = b;
                    a.download = `${name}.${fmt === 'image/jpeg' ? 'jpg' : 'png'}`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`âœ… å·²ä¿å­˜ï¼š${a.download}`);
                }, fmt, 0.95);
            } catch (e) { alert("âŒ " + e.message); }
            finally { elements.generateBtn.innerText = oldTxt; elements.generateBtn.disabled = false; }
        }

        async function initApp() {
            elements.res4k.checked = true;
            initEventListeners();
            // å¯åŠ¨å¹¶è¡ŒåŠ è½½
            preloadResources();
        }
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
