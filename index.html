<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â•ΩËé≥Â®ÅÊ±ÄÊ∞¥Âè∞</title>
    
    <!-- PWA ÈÖçÁΩÆ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f5f5f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* üéâ ÂÖ®Êñ∞Âä†ËΩΩÈÅÆÁΩ©Ê†∑Âºè */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
            padding: 20px;
            text-align: center;
        }
        .loading-icon {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        .loading-tip {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
            max-width: 300px;
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .loading-tip strong {
            color: #ff4757;
            font-weight: 600;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin: 10px 0 20px 0;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .version-tag {
            font-size: 0.8rem;
            background: #e9ecef;
            color: #6c757d;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .form-group { margin-bottom: 12px; }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .form-label {
            width: 90px;
            text-align: right;
            margin-right: 10px;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 150px;
        }

        .name-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }
        .name-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        .size-btn {
            width: 32px; height: 38px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            flex-shrink: 0;
        }
        .size-btn:active { background: #e2e6ea; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 1rem;
            flex: 1;
            text-align: center;
            font-weight: 500;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .photo-btn-fixed {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 150px;
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        /* ‚úÖ ÊâãÊú∫Á´ØÂ∏ÉÂ±Ä‰ºòÂåñ */
        @media (max-width: 768px) {
            .form-row { flex-direction: column; align-items: stretch; gap: 5px; }
            .form-label { width: 100%; text-align: left; margin-bottom: 2px; font-weight: bold;}
            .form-input, .name-input-group { width: 100%; box-sizing: border-box; }
            .btn { width: 100%; margin-right: 0; }
            .controls-wrapper { flex-direction: row !important; }
            .control-group { width: 48% !important; padding: 10px; }
            
            .row-desktop-mobile {
                flex-direction: row !important;
                align-items: center !important;
                gap: 5px !important;
            }
            .row-desktop-mobile .form-label {
                width: auto !important;
                text-align: right !important;
                margin-right: 5px !important;
                margin-bottom: 0 !important;
                font-weight: bold;
                font-size: 0.9rem;
                flex-shrink: 0;
            }
            .row-desktop-mobile .form-input {
                flex: 1 !important;
                min-width: 100px !important;
                padding: 8px !important;
                font-size: 14px !important;
            }
        }

        .preview-container {
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 15px;
            text-align: center;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-image { max-width: 100%; height: auto; display: block; }

        .controls-wrapper {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        .control-group {
            flex: 1;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            display: block;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .control-title {
            margin: 0;
            font-size: 0.95rem;
            color: #444;
            font-weight: bold;
        }
        .control-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn {
            background: none; border: 1px solid #ddd; border-radius: 4px;
            width: 26px; height: 26px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 16px; color: #555; padding: 0;
        }
        .icon-btn:hover { background: #f1f1f1; }
        .icon-btn.reset-btn { color: #007bff; border-color: #007bff; }
        
        .control-content { transition: all 0.3s ease; }
        .control-content.collapsed { display: none; }

        .slider-group { margin-bottom: 12px; }
        .slider-label-top {
            display: block;
            text-align: left;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .slider-wrapper { width: 100%; margin: 0; }
        input[type=range] { width: 100%; height: 24px; }

        .export-options {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .export-title { margin: 0; font-size: 1rem; color: #444; font-weight: bold; }
        .export-content { transition: all 0.3s ease; }
        .export-content.collapsed { display: none; }
        
        .export-inner-flex {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
        }
        .export-col {
            flex: 1;
            min-width: 0;
        }
        .export-col label.main-label {
            font-weight: bold;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 6px;
            color: #333;
        }
        
        .radio-group { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .radio-item { 
            display: flex; 
            align-items: center; 
            font-size: 0.9rem; 
            white-space: nowrap; 
        }
        .radio-item input { 
            margin-right: 4px; 
            transform: scale(1.1); 
        }
        
        .file-info { margin-left: 10px; color: #666; font-size: 0.9rem; word-break: break-all; line-height: 40px; }
        .hidden { display: none; }
        .size-display { font-size: 0.8rem; color: #666; width: 35px; text-align: center; flex-shrink: 0; }
    </style>
</head>
<body>

    <!-- üéâ ÂÖ®Êñ∞Âä†ËΩΩÈÅÆÁΩ© -->
    <div id="loading-overlay">
        <img src="./icon-512.png" alt="Logo" class="loading-icon">
        <div class="loading-tip">
            È¶ñÊ¨°Âä†ËΩΩÂ§ßÊ¶ÇÈúÄË¶Å<strong>3ÂàÜÈíü</strong>Ôºå<br>ËØ∑ËÄêÂøÉÁ≠âÂæÖ...
        </div>
    </div>

    <div class="container">
        <h1>
            Â•ΩËé≥Â®ÅÊ±ÄÊ∞¥Âè∞ 
            <span class="version-tag">v1.7</span>
        </h1>
        
        <div class="form-group">
            <div class="form-row row-desktop-mobile">
                <label class="form-label">ÂéÖÊó∂ÊÆµ:</label>
                <input type="text" id="timeInput" class="form-input" placeholder="‰æãÔºöÂ••ÊñØÂç°ÊôöÂÆ¥">
                
                <label class="form-label" style="margin-left: 10px;">ÂÆ¥Â∏≠Á±ªÂûã:</label>
                <input type="text" id="typeInput" class="form-input" placeholder="‰æãÔºöÂ©öÂÆ¥">
            </div>
            
            <div class="form-row">
                <label class="form-label">Êñ∞ÈÉéÂßìÂêç:</label>
                <div class="name-input-group">
                    <input type="text" id="groomInput" class="name-input" placeholder="‰æãÔºö‚ÄúÊñ∞ÈÉéÔºöÂº†‰∏â‚ÄùÊàñ‚Äú‰∫∫Âêç‚Äù">
                    <div class="size-btn" id="groomMinus">‚àí</div>
                    <div class="size-display" id="groomSizeDisplay">100%</div>
                    <div class="size-btn" id="groomPlus">+</div>
                </div>
            </div>
            
            <div class="form-row">
                <label class="form-label">Êñ∞Â®òÂßìÂêç:</label>
                <div class="name-input-group">
                    <input type="text" id="brideInput" class="name-input" placeholder="‰æãÔºö‚ÄúÊñ∞Â®òÔºöÊùéÂõõ‚ÄùÊàñÁ©∫ÁùÄ">
                    <div class="size-btn" id="brideMinus">‚àí</div>
                    <div class="size-display" id="brideSizeDisplay">100%</div>
                    <div class="size-btn" id="bridePlus">+</div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="form-row" style="flex-direction: row; align-items: center;">
                <button id="photoBtn" class="btn btn-primary photo-btn-fixed">üñºÔ∏è ÈÄâÂõæ</button>
                <span id="photoInfo" class="file-info">Êú™ÈÄâÊã©</span>
                <input type="file" id="photoFile" accept="image/*" class="hidden">
            </div>
        </div>

        <div class="controls-wrapper">
            <div id="cropControls" class="control-group">
                <div class="control-header">
                    <h4 class="control-title">ÂõæÁâá‰ΩçÁΩÆ</h4>
                    <div class="control-actions">
                        <button class="icon-btn reset-btn" id="resetCropBtn" title="ÈáçÁΩÆ">üîÑ</button>
                        <button class="icon-btn" id="toggleCropBtn" title="Â±ïÂºÄ/ÊäòÂè†">+</button>
                    </div>
                </div>
                <div class="control-content collapsed" id="cropContent">
                    <div class="slider-group">
                        <label class="slider-label-top">Â∑¶Âè≥</label>
                        <div class="slider-wrapper"><input type="range" id="hSlider" min="-500" max="500" value="0" step="25"></div>
                    </div>
                    <div class="slider-group">
                        <label class="slider-label-top">‰∏ä‰∏ã</label>
                        <div class="slider-wrapper"><input type="range" id="vSlider" min="-500" max="500" value="0" step="25"></div>
                    </div>
                </div>
            </div>

            <div id="nameControls" class="control-group" style="display:none;">
                <div class="control-header">
                    <h4 class="control-title">ÂßìÂêç‰ΩçÁΩÆ</h4>
                    <div class="control-actions">
                        <button class="icon-btn reset-btn" id="resetNameBtn" title="ÈáçÁΩÆ">üîÑ</button>
                        <button class="icon-btn" id="toggleNameBtn" title="Â±ïÂºÄ/ÊäòÂè†">+</button>
                    </div>
                </div>
                <div class="control-content collapsed" id="nameContent">
                    <div class="slider-group">
                        <label class="slider-label-top">Â∑¶Âè≥</label>
                        <div class="slider-wrapper"><input type="range" id="nameHSlider" min="-1000" max="1000" value="0" step="10"></div>
                    </div>
                    <div class="slider-group">
                        <label class="slider-label-top">‰∏ä‰∏ã</label>
                        <div class="slider-wrapper"><input type="range" id="nameVSlider" min="-1000" max="1000" value="0" step="10"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="preview-container">
            <canvas id="previewCanvas" class="preview-image"></canvas>
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <button id="refreshBtn" class="btn btn-warning">üîÑ Âà∑Êñ∞È¢ÑËßà</button>
        </div>

        <div class="export-options">
            <div class="export-header">
                <h3 class="export-title">ÂØºÂá∫ËÆæÁΩÆ</h3>
                <button class="icon-btn" id="toggleExportBtn" title="Â±ïÂºÄ/ÊäòÂè†">+</button>
            </div>
            <div class="export-content collapsed" id="exportContent">
                <div class="export-inner-flex">
                    <div class="export-col">
                        <label class="main-label">ÂàÜËæ®Áéá:</label>
                        <div class="radio-group">
                            <label class="radio-item"><input type="radio" name="resolution" id="res4k" value="4k" checked> 4K</label>
                            <label class="radio-item"><input type="radio" name="resolution" id="res1k" value="1k"> 1K</label>
                        </div>
                    </div>
                    <div class="export-col">
                        <label class="main-label">Ê†ºÂºè:</label>
                        <div class="radio-group">
                            <label class="radio-item"><input type="radio" name="format" id="fmtJpg" value="jpg" checked> JPG</label>
                            <label class="radio-item"><input type="radio" name="format" id="fmtPng" value="png"> PNG</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button id="generateBtn" class="btn btn-success" style="font-size: 1.1rem; font-weight: bold;">üíæ ÁîüÊàêÂπ∂‰øùÂ≠òÂõæÁâá</button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ SW OK:', reg.scope))
                    .catch(err => console.error('‚ùå SW Fail:', err));
            });
        }
    </script>

    <script>
        const BACKGROUND_URL = "./back.png";
        const FONT_URL = "./FZXiaoBiaoSong-B05S.woff2";
        const BASE_FONT_SIZE = 192;
        
        let userImageBase64 = null;
        let cropOffsetX = 0, cropOffsetY = 0;
        let nameOffsetX = 0, nameOffsetY = 0;
        let groomScale = 100, brideScale = 100;
        let customFontFamily = 'serif';
        let resourcesLoaded = false;
        let bgImageObj = null;

        const elements = {
            timeInput: document.getElementById('timeInput'),
            typeInput: document.getElementById('typeInput'),
            groomInput: document.getElementById('groomInput'),
            brideInput: document.getElementById('brideInput'),
            photoBtn: document.getElementById('photoBtn'),
            photoFile: document.getElementById('photoFile'),
            photoInfo: document.getElementById('photoInfo'),
            cropControls: document.getElementById('cropControls'),
            cropContent: document.getElementById('cropContent'),
            toggleCropBtn: document.getElementById('toggleCropBtn'),
            resetCropBtn: document.getElementById('resetCropBtn'),
            hSlider: document.getElementById('hSlider'),
            vSlider: document.getElementById('vSlider'),
            nameControls: document.getElementById('nameControls'),
            nameContent: document.getElementById('nameContent'),
            toggleNameBtn: document.getElementById('toggleNameBtn'),
            resetNameBtn: document.getElementById('resetNameBtn'),
            nameHSlider: document.getElementById('nameHSlider'),
            nameVSlider: document.getElementById('nameVSlider'),
            toggleExportBtn: document.getElementById('toggleExportBtn'),
            exportContent: document.getElementById('exportContent'),
            previewCanvas: document.getElementById('previewCanvas'),
            refreshBtn: document.getElementById('refreshBtn'),
            res4k: document.getElementById('res4k'),
            res1k: document.getElementById('res1k'),
            fmtJpg: document.getElementById('fmtJpg'),
            fmtPng: document.getElementById('fmtPng'),
            generateBtn: document.getElementById('generateBtn'),
            groomMinus: document.getElementById('groomMinus'),
            groomPlus: document.getElementById('groomPlus'),
            groomSizeDisplay: document.getElementById('groomSizeDisplay'),
            brideMinus: document.getElementById('brideMinus'),
            bridePlus: document.getElementById('bridePlus'),
            brideSizeDisplay: document.getElementById('brideSizeDisplay'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        function initCollapsibles() {
            const setupToggle = (btn, content, defaultOpen = false) => {
                if (!defaultOpen) content.classList.add('collapsed');
                btn.textContent = defaultOpen ? '‚àí' : '+';
                btn.addEventListener('click', () => {
                    const isCollapsed = content.classList.contains('collapsed');
                    content.classList.toggle('collapsed');
                    btn.textContent = isCollapsed ? '‚àí' : '+';
                });
            };
            setupToggle(elements.toggleCropBtn, elements.cropContent, false);
            setupToggle(elements.toggleNameBtn, elements.nameContent, false);
            setupToggle(elements.toggleExportBtn, elements.exportContent, false);

            elements.resetCropBtn.addEventListener('click', () => {
                elements.hSlider.value = 0; elements.vSlider.value = 0;
                cropOffsetX = 0; cropOffsetY = 0; updatePreview();
            });
            elements.resetNameBtn.addEventListener('click', () => {
                elements.nameHSlider.value = 0; elements.nameVSlider.value = 0;
                nameOffsetX = 0; nameOffsetY = 0; updatePreview();
            });
        }

        async function preloadResources() {
            const loadFontPromise = (async () => {
                if (!FONT_URL) return 'serif';
                const fontName = 'FZXiaoBiaoSong';
                const style = document.createElement('style');
                style.textContent = `@font-face { font-family: "${fontName}"; src: url('${FONT_URL}') format("woff2"); }`;
                document.head.appendChild(style);
                try {
                    await document.fonts.load(`${BASE_FONT_SIZE}px "${fontName}"`);
                    return fontName;
                } catch (e) { return 'serif'; }
            })();

            const loadBgPromise = (async () => {
                const img = new Image();
                img.src = BACKGROUND_URL;
                img.crossOrigin = "Anonymous";
                return new Promise((resolve) => {
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                });
            })();

            const [fontFamily, bgImg] = await Promise.all([loadFontPromise, loadBgPromise]);
            
            customFontFamily = fontFamily;
            bgImageObj = bgImg;
            resourcesLoaded = true;

            if (elements.loadingOverlay) {
                elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => elements.loadingOverlay.style.display = 'none', 500);
            }
            
            updatePreview();
        }

        function initEventListeners() {
            initCollapsibles();
            elements.photoBtn.addEventListener('click', () => elements.photoFile.click());
            elements.photoFile.addEventListener('change', handlePhotoUpload);
            
            elements.hSlider.addEventListener('input', (e) => { cropOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.vSlider.addEventListener('input', (e) => { cropOffsetY = parseInt(e.target.value); updatePreview(); });
            elements.nameHSlider.addEventListener('input', (e) => { nameOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.nameVSlider.addEventListener('input', (e) => { nameOffsetY = parseInt(e.target.value); updatePreview(); });

            elements.groomPlus.addEventListener('click', () => { groomScale = Math.min(groomScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.groomMinus.addEventListener('click', () => { groomScale = Math.max(groomScale - 10, 20); updateSizeUI(); updatePreview(); });
            elements.bridePlus.addEventListener('click', () => { brideScale = Math.min(brideScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.brideMinus.addEventListener('click', () => { brideScale = Math.max(brideScale - 10, 20); updateSizeUI(); updatePreview(); });

            elements.refreshBtn.addEventListener('click', updatePreview);
            elements.generateBtn.addEventListener('click', generateImage);
            
            [elements.timeInput, elements.groomInput, elements.brideInput, elements.typeInput].forEach(input => {
                input.addEventListener('input', updatePreview);
            });
        }

        function updateSizeUI() {
            elements.groomSizeDisplay.textContent = groomScale + '%';
            elements.brideSizeDisplay.textContent = brideScale + '%';
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                userImageBase64 = e.target.result;
                elements.photoInfo.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                checkNameControls();
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function checkNameControls() {
            const hasName = elements.groomInput.value.trim() || elements.brideInput.value.trim();
            elements.nameControls.style.display = hasName ? 'block' : 'none';
        }

        function getResolution() {
            if (elements.res4k.checked) return { width: 3840, height: 2160 };
            return { width: 1920, height: 1080 };
        }

        function loadFont(size) { return `${size}px "${customFontFamily}"`; }

        function cropToTarget(img, targetW = 2544, targetH = 1760) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const ratio = targetW / targetH;
            const origRatio = img.width / img.height;
            let newW, newH;
            if (origRatio > ratio) { newH = targetH; newW = newH * origRatio; }
            else { newW = targetW; newH = newW / origRatio; }
            canvas.width = newW; canvas.height = newH;
            ctx.drawImage(img, 0, 0, newW, newH);
            let left = (newW - targetW) / 2;
            let top = (newH - targetH) / 2;
            left = Math.max(0, Math.min(left + cropOffsetX, newW - targetW));
            top = Math.max(0, Math.min(top + cropOffsetY, newH - targetH));
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = targetW; cropCanvas.height = targetH;
            cropCanvas.getContext('2d').drawImage(canvas, left, top, targetW, targetH, 0, 0, targetW, targetH);
            return cropCanvas;
        }

        function drawText(ctx, x, y, text, font, fill) {
            ctx.font = font; ctx.fillStyle = fill; ctx.fillText(text, x, y);
        }
        function drawBoldText(ctx, x, y, text, font, fill) {
            ctx.font = font; ctx.fillStyle = fill;
            [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dx,dy]) => ctx.fillText(text, x+dx, y+dy));
            ctx.fillText(text, x, y);
        }

        // ‚úÖ Êñ∞Â¢ûÔºöÊô∫ËÉΩÂ§ÑÁêÜÂßìÂêçÈó¥Ë∑ùÁöÑÂáΩÊï∞
        function processNameSpacing(name) {
            if (!name) return name;
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‚ÄúÊñ∞ÈÉéÔºö‚ÄùÊàñ‚ÄúÊñ∞Â®òÔºö‚Äù
            const prefixes = ["Êñ∞ÈÉéÔºö", "Êñ∞Â®òÔºö"];
            for (let prefix of prefixes) {
                if (name.startsWith(prefix)) {
                    const realName = name.substring(prefix.length);
                    // Â¶ÇÊûúÂÜíÂè∑ÂêéÊ≠£Â•ΩÊòØ2‰∏™Â≠óÔºåÂàôÂú®‰∏≠Èó¥Âä†‰∏Ä‰∏™ÂÖ®ËßíÁ©∫Ê†º
                    if (realName.length === 2) {
                        return prefix + realName[0] + "\u3000\u3000" + realName[1];
                    }
                }
            }
            return name;
        }

        async function generateCompositeImage(isPreview = false) {
            const canvas = document.createElement('canvas');
            let renderW = 3840, renderH = 2160;
            if (isPreview) {
                const containerW = elements.previewCanvas.parentElement.clientWidth;
                renderW = Math.min(1920, containerW * 2); 
                renderH = Math.floor(renderW * (2160/3840));
            }

            canvas.width = renderW;
            canvas.height = renderH;
            const ctx = canvas.getContext('2d');
            const scaleX = renderW / 3840;
            const scaleY = renderH / 2160;

            if (bgImageObj) {
                ctx.drawImage(bgImageObj, 0, 0, renderW, renderH);
            } else {
                ctx.fillStyle = "#ddd";
                ctx.fillRect(0, 0, renderW, renderH);
            }

            const hallTime = elements.timeInput.value.trim() || "‰ªÄ‰πàÂéÖÊôöÂÆ¥";
            // ‚úÖ ‰ΩøÁî®Êñ∞ÂáΩÊï∞Â§ÑÁêÜÂßìÂêç
            const groomRaw = elements.groomInput.value.trim();
            const brideRaw = elements.brideInput.value.trim();
            const groom = processNameSpacing(groomRaw);
            const bride = processNameSpacing(brideRaw);
            
            const weddingType = elements.typeInput.value.trim() || "Ê≤°ÂÜôÂÆ¥";
            const textColor = "rgba(120, 65, 25, 1)";

            const baseX = (650 - 536) * scaleX; 
            const baseGroomY = (1110 + 158) * scaleY;
            const baseBrideY = (1380 + 158) * scaleY;
            const baseTimeX = 280 * scaleX, baseTimeY = (490 + 148) * scaleY;
            const baseTypeX = 3100 * scaleX, baseTypeY = (100 + 167) * scaleY;

            const finalX = baseX + (nameOffsetX * scaleX);
            let finalGroomY = baseGroomY + (nameOffsetY * scaleY);
            let finalBrideY = baseBrideY + (nameOffsetY * scaleY);

            // Ê≥®ÊÑèÔºöÂõ†‰∏∫Âä†‰∫ÜÁ©∫Ê†ºÔºåÂ≠óÁ¨¶‰∏≤ÈïøÂ∫¶Âèò‰∫ÜÔºå‰ΩÜËßÜËßâ‰∏äÊàë‰ª¨Â∏åÊúõÂØπÈΩê„ÄÇ
            // ËøôÈáåÁöÑÈÄªËæë‰øùÊåÅÂéüÊ†∑ÔºåÂõ†‰∏∫Á©∫Ê†º‰πü‰ºöÂç†Áî®ÂÆΩÂ∫¶ÔºåËßÜËßâ‰∏ä‰ºöËá™Âä®ÊíëÂºÄ„ÄÇ
            // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ÂêçÂ≠óÔºåÁ®çÂæÆ‰∏ãÁßª‰∏ÄÁÇπ‰øùÊåÅÂ±Ö‰∏≠ÊÑü
            if (groom && !bride) finalGroomY += 120 * scaleY;

            const fontSizeScale = scaleX; 
            if (hallTime) drawBoldText(ctx, baseTimeX, baseTimeY, hallTime, loadFont(166 * fontSizeScale), textColor);
            if (weddingType) drawText(ctx, baseTypeX, baseTypeY, weddingType, loadFont(220 * fontSizeScale), textColor);

            if (groom) drawText(ctx, finalX, finalGroomY, groom, loadFont(BASE_FONT_SIZE * (groomScale/100) * fontSizeScale), textColor);
            if (bride) drawText(ctx, finalX, finalBrideY, bride, loadFont(BASE_FONT_SIZE * (brideScale/100) * fontSizeScale), textColor);

            if (userImageBase64) {
                try {
                    const userImg = new Image();
                    userImg.src = userImageBase64;
                    await new Promise(r => { userImg.onload = r; });
                    const processedImg = cropToTarget(userImg, 2544, 1760);
                    const uW = 2544 * scaleX;
                    const uH = 1760 * scaleY;
                    ctx.drawImage(processedImg, renderW - uW, renderH - uH, uW, uH);
                } catch (e) { console.error(e); }
            }

            if (!isPreview) {
                const targetRes = getResolution();
                if (targetRes.width !== renderW || targetRes.height !== renderH) {
                    const fC = document.createElement('canvas');
                    fC.width = targetRes.width; fC.height = targetRes.height;
                    fC.getContext('2d').drawImage(canvas, 0, 0, targetRes.width, targetRes.height);
                    return fC;
                }
            }
            return canvas;
        }

        async function updatePreview() {
            const pCtx = elements.previewCanvas.getContext('2d');
            const w = elements.previewCanvas.parentElement.clientWidth - 20;
            elements.previewCanvas.width = w; 
            elements.previewCanvas.height = 200;
            pCtx.fillStyle = "#f0f0f0"; 
            pCtx.fillRect(0,0,w,200);
            
            if (!resourcesLoaded) {
                pCtx.fillStyle = "#999"; pCtx.font = "14px Arial"; pCtx.textAlign = "center";
                pCtx.fillText("ËµÑÊ∫êÂä†ËΩΩ‰∏≠...", w/2, 100);
                return;
            }

            try {
                const composite = await generateCompositeImage(true);
                const h = Math.floor(w * composite.height / composite.width);
                elements.previewCanvas.width = w; 
                elements.previewCanvas.height = h;
                pCtx.drawImage(composite, 0, 0, w, h);
                checkNameControls();
            } catch (e) {
                pCtx.fillStyle = "red"; pCtx.fillText("Âá∫Èîô", w/2, 100);
            }
        }

        async function generateImage() {
            if (!resourcesLoaded) { alert("ËµÑÊ∫êÂä†ËΩΩ‰∏≠..."); return; }
            const oldTxt = elements.generateBtn.innerText;
            elements.generateBtn.innerText = "‚è≥ ÁîüÊàê‰∏≠...";
            elements.generateBtn.disabled = true;
            try {
                const composite = await generateCompositeImage(false);
                const fmt = elements.fmtJpg.checked ? 'image/jpeg' : 'image/png';
                composite.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const g = elements.groomInput.value.trim();
                    const b = elements.brideInput.value.trim();
                    let name = "wedding";
                    if (g && b) name = `${g} ${b}`;
                    else if (g) name = g;
                    else if (b) name = b;
                    a.download = `${name}.${fmt === 'image/jpeg' ? 'jpg' : 'png'}`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`‚úÖ Â∑≤‰øùÂ≠òÔºö${a.download}`);
                }, fmt, 0.95);
            } catch (e) { alert("‚ùå " + e.message); }
            finally { elements.generateBtn.innerText = oldTxt; elements.generateBtn.disabled = false; }
        }

        async function initApp() {
            elements.res4k.checked = true;
            initEventListeners();
            preloadResources();
        }
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

