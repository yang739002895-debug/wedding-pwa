<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç¦æ­¢ç¼©æ”¾ï¼Œæå‡ App ä½“éªŒ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½è³å¨æ±€æ°´å°</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f5f5f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* ================= å…¨å±€æ ·å¼ ================= */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
            /* é€‚é…å…¨é¢å±å®‰å…¨åŒºåŸŸ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group { margin-bottom: 12px; }
        
        /* ================= å“åº”å¼è¡¨å• ================= */
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-label {
            width: 90px;
            text-align: right;
            margin-right: 10px;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 200px;
        }

        /* ================= æŒ‰é’®æ ·å¼ ================= */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 1rem;
            flex: 1;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
                /* âœ… ä¿®å¤é€‰å›¾æŒ‰é’®åœ¨æ‰‹æœºç«¯å˜å¤§çš„é—®é¢˜ */
        .photo-btn-fixed {
            flex: 0 0 auto !important; /* å¼ºåˆ¶ä¸è·Ÿéš flex æ‹‰ä¼¸ */
            width: auto !important;    /* å®½åº¦è‡ªé€‚åº”å†…å®¹ */
            max-width: 150px;          /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå®½ */
            margin-right: 10px;        /* å’Œåé¢çš„æ–‡å­—ä¿æŒé—´è· */
            margin-bottom: 0;          /* å–æ¶ˆåº•éƒ¨çš„ marginï¼Œå¯¹é½æ›´ç¾è§‚ */
        }
        
        /* ================= æ‰‹æœºç«¯å¸ƒå±€é€‚é… ================= */
        @media (max-width: 600px) {
            .form-row { flex-direction: column; align-items: stretch; }
            .form-label { width: 100%; text-align: left; margin-bottom: 5px; font-weight: bold;}
            .form-input { width: 100%; box-sizing: border-box; }
            .btn { width: 100%; margin-right: 0; }
            .radio-group { flex-direction: column; gap: 8px; }
        }

        .preview-container {
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 15px;
            text-align: center;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-image {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .crop-controls {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            display: none;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin: 12px 0;
        }
        .slider-label {
            width: 50px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            flex-shrink: 0;
        }
        .slider-wrapper { flex: 1; margin: 0 10px; }
        input[type=range] { width: 100%; height: 25px; }

        .export-options {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .radio-item {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        .radio-item input { margin-right: 6px; transform: scale(1.2); }
        
        .file-info {
            margin-left: 10px;
            color: #666;
            font-size: 0.9rem;
            word-break: break-all;
            line-height: 40px;
        }
        .hidden { display: none; }
        
        /* åŠ è½½æç¤º */
        .loading-tip {
            color: #999;
            font-size: 0.9rem;
            margin-top: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¥½è³å¨æ±€æ°´å°</h1>
        
        <!-- è¾“å…¥å­—æ®µ -->
        <div class="form-group">
            <div class="form-row">
                <label class="form-label">å…æ—¶æ®µ:</label>
                <!-- é»˜è®¤å€¼ï¼šå¥¥æ–¯å¡æ™šå®´ -->
                <input type="text" id="timeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¥¥æ–¯å¡æ™šå®´">
            </div>
            <div class="form-row">
                <label class="form-label">æ–°éƒå§“å:</label>
                <input type="text" id="groomInput" class="form-input" placeholder="è¯·è¾“å…¥æ–°éƒå§“å">
            </div>
            <div class="form-row">
                <label class="form-label">æ–°å¨˜å§“å:</label>
                <input type="text" id="brideInput" class="form-input" placeholder="è¯·è¾“å…¥æ–°å¨˜å§“å">
            </div>
            <div class="form-row">
                <label class="form-label">å®´å¸­ç±»å‹:</label>
                <input type="text" id="typeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå©šå®´">
            </div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="form-group">
    <!-- ä¿®æ”¹ç‚¹ï¼šå»æ‰ style ä¸­çš„ flex-wrap: nowrapï¼Œå…è®¸æ¢è¡Œ -->
    <div class="form-row" style="flex-direction: row; align-items: center;">
        <!-- ä¿®æ”¹ç‚¹ï¼šç»™æŒ‰é’®åŠ ä¸€ä¸ª max-width å’Œç‰¹å®šçš„ class æ ·å¼ -->
        <button id="photoBtn" class="btn btn-primary photo-btn-fixed" style="flex: 0 0 auto; padding: 10px 20px; max-width: 120px;">ğŸ–¼ï¸ é€‰å›¾</button>
        <span id="photoInfo" class="file-info" style="margin-left: 10px; font-size: 0.9rem;">æœªé€‰æ‹©</span>
        <input type="file" id="photoFile" accept="image/*" class="hidden">
            </div>
        </div>

        <!-- è£å‰ªæ§åˆ¶ -->
        <div id="cropControls" class="crop-controls">
            <h4 style="margin-top:0; font-size: 1rem; color:#444;">ğŸ“· å›¾ç‰‡ä½ç½®è°ƒæ•´</h4>
            <div class="slider-container">
                <span class="slider-label">å·¦å³</span>
                <div class="slider-wrapper">
                    <input type="range" id="hSlider" min="-500" max="500" value="0" step="25">
                </div>
            </div>
            <div class="slider-container">
                <span class="slider-label">ä¸Šä¸‹</span>
                <div class="slider-wrapper">
                    <input type="range" id="vSlider" min="-500" max="500" value="0" step="25">
                </div>
            </div>
            <div style="text-align: center; font-size: 0.8rem; color: #999; margin-top:5px;">æ‹–åŠ¨æ»‘å—å¾®è°ƒå›¾ç‰‡ä½ç½®</div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-container">
            <canvas id="previewCanvas" class="preview-image"></canvas>
            <div id="loadingMsg" class="loading-tip" style="display:none;">æ­£åœ¨åŠ è½½èµ„æºï¼Œè¯·ç¨å€™...</div>
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <button id="refreshBtn" class="btn btn-warning">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
        </div>

        <!-- å¯¼å‡ºè®¾ç½® -->
        <div class="export-options">
            <h3 style="font-size: 1rem; margin-top:0; color:#444;">å¯¼å‡ºè®¾ç½®</h3>
            <div class="form-row" style="flex-direction: column; align-items: flex-start;">
                <label style="font-weight:bold; font-size:0.9rem;">åˆ†è¾¨ç‡:</label>
                <div class="radio-group">
                    <!-- é»˜è®¤é€‰ä¸­ 4K -->
                    <label class="radio-item">
                        <input type="radio" name="resolution" id="res4k" value="4k" checked> 4K (3840Ã—2160)
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="resolution" id="res1k" value="1k"> 1080P (1920Ã—1080)
                    </label>
                </div>
            </div>
            <div class="form-row" style="flex-direction: column; align-items: flex-start; margin-top:10px;">
                <label style="font-weight:bold; font-size:0.9rem;">æ ¼å¼:</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="format" id="fmtJpg" value="jpg" checked> JPG (ä½“ç§¯å°)
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="format" id="fmtPng" value="png"> PNG (æ¸…æ™°)
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button id="generateBtn" class="btn btn-success" style="font-size: 1.1rem; font-weight: bold;">ğŸ’¾ ç”Ÿæˆå¹¶ä¿å­˜å›¾ç‰‡</button>
        </div>
    </div>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('âœ… SW OK:', reg.scope))
                    .catch(err => console.error('âŒ SW Fail:', err));
            });
        }
    </script>

    <script>
        // ================= é…ç½®åŒº =================
        const BACKGROUND_URL = "./back.png"; 
        const FONT_URL = "./FZXiaoBiaoSong-B05S.woff2";
        // =========================================

        let userImageBase64 = null;
        let cropOffsetX = 0;
        let cropOffsetY = 0;
        let customFontFamily = 'serif';
        let resourcesLoaded = false;

        // è·å– DOM å…ƒç´ 
        const elements = {
            timeInput: document.getElementById('timeInput'),
            groomInput: document.getElementById('groomInput'),
            brideInput: document.getElementById('brideInput'),
            typeInput: document.getElementById('typeInput'),
            photoBtn: document.getElementById('photoBtn'),
            photoFile: document.getElementById('photoFile'),
            photoInfo: document.getElementById('photoInfo'),
            cropControls: document.getElementById('cropControls'),
            hSlider: document.getElementById('hSlider'),
            vSlider: document.getElementById('vSlider'),
            previewCanvas: document.getElementById('previewCanvas'),
            refreshBtn: document.getElementById('refreshBtn'),
            res4k: document.getElementById('res4k'),
            res1k: document.getElementById('res1k'),
            fmtJpg: document.getElementById('fmtJpg'),
            fmtPng: document.getElementById('fmtPng'),
            generateBtn: document.getElementById('generateBtn'),
            loadingMsg: document.getElementById('loadingMsg')
        };

        // ================= æ ¸å¿ƒä¿®å¤ï¼šå®šä¹‰ loadCustomFont å‡½æ•° =================
        /**
         * åŠ¨æ€åŠ è½½è‡ªå®šä¹‰å­—ä½“
         * ä¿®å¤äº†ä¹‹å‰ "loadCustomFont is not defined" çš„æŠ¥é”™
         */
        async function loadCustomFont() {
            if (!FONT_URL) {
                console.warn('æœªé…ç½®å­—ä½“ URLï¼Œä½¿ç”¨é»˜è®¤å­—ä½“');
                return 'serif';
            }

            const fontName = 'FZXiaoBiaoSong';
            
            // åˆ›å»º style æ ‡ç­¾æ³¨å…¥ @font-face
            const style = document.createElement('style');
            style.textContent = `
                @font-face {
                    font-family: "${fontName}";
                    src: url('${FONT_URL}') format("woff2");
                }
            `;
            document.head.appendChild(style);

            // ç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ
            try {
                await document.fonts.load(`192px "${fontName}"`);
                console.log('âœ… è‡ªå®šä¹‰å­—ä½“åŠ è½½æˆåŠŸ');
                return fontName;
            } catch (e) {
                console.error('âŒ å­—ä½“åŠ è½½å¤±è´¥:', e);
                return 'serif';
            }
        }
        // ===================================================================

        // é¢„åŠ è½½èƒŒæ™¯å›¾
        async function preloadResources() {
            elements.loadingMsg.style.display = 'block';
            elements.loadingMsg.textContent = "æ­£åœ¨åŠ è½½èƒŒæ™¯å›¾å’Œå­—ä½“...";
            
            try {
                // 1. åŠ è½½å­—ä½“
                customFontFamily = await loadCustomFont();

                // 2. é¢„åŠ è½½èƒŒæ™¯å›¾
                const bgImg = new Image();
                bgImg.src = BACKGROUND_URL;
                await new Promise((resolve, reject) => {
                    bgImg.onload = resolve;
                    bgImg.onerror = () => reject(new Error("èƒŒæ™¯å›¾åŠ è½½å¤±è´¥"));
                });

                resourcesLoaded = true;
                elements.loadingMsg.style.display = 'none';
                console.log("âœ… æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ");
            } catch (e) {
                console.error("èµ„æºåŠ è½½é”™è¯¯:", e);
                elements.loadingMsg.textContent = "èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚";
                elements.loadingMsg.style.color = "red";
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            elements.photoBtn.addEventListener('click', () => elements.photoFile.click());
            elements.photoFile.addEventListener('change', handlePhotoUpload);
            elements.hSlider.addEventListener('input', handleCropChange);
            elements.vSlider.addEventListener('input', handleCropChange);
            elements.refreshBtn.addEventListener('click', updatePreview);
            elements.generateBtn.addEventListener('click', generateImage);
            
            [elements.timeInput, elements.groomInput, elements.brideInput, elements.typeInput].forEach(input => {
                input.addEventListener('input', updatePreview);
            });
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                userImageBase64 = e.target.result;
                elements.photoInfo.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                elements.cropControls.style.display = 'block';
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        // å¤„ç†æ»‘å—å˜åŒ–
        function handleCropChange() {
            cropOffsetX = parseInt(elements.hSlider.value);
            cropOffsetY = parseInt(elements.vSlider.value);
            updatePreview();
        }

        // è·å–åˆ†è¾¨ç‡
        function getResolution() {
            if (elements.res4k.checked) return { width: 3840, height: 2160 };
            return { width: 1920, height: 1080 };
        }

        // è·å–å­—ä½“æ ·å¼
        function loadFont(size) {
            return `${size}px "${customFontFamily}"`;
        }

        // è£å‰ªå›¾ç‰‡é€»è¾‘
        function cropToTarget(img, targetW = 2544, targetH = 1760) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const targetRatio = targetW / targetH;
            const origRatio = img.width / img.height;
            let newW, newH;
            if (origRatio > targetRatio) {
                newH = targetH;
                newW = newH * origRatio;
            } else {
                newW = targetW;
                newH = newW / origRatio;
            }
            canvas.width = newW;
            canvas.height = newH;
            ctx.drawImage(img, 0, 0, newW, newH);
            let left = (newW - targetW) / 2;
            let top = (newH - targetH) / 2;
            left = Math.max(0, Math.min(left + cropOffsetX, newW - targetW));
            top = Math.max(0, Math.min(top + cropOffsetY, newH - targetH));
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = targetW;
            cropCanvas.height = targetH;
            const cropCtx = cropCanvas.getContext('2d');
            cropCtx.drawImage(canvas, left, top, targetW, targetH, 0, 0, targetW, targetH);
            return cropCanvas;
        }

        // ç»˜åˆ¶æ™®é€šæ–‡æœ¬
        function drawText(ctx, x, y, text, font, fill) {
            ctx.font = font;
            ctx.fillStyle = fill;
            ctx.fillText(text, x, y);
        }

        // ç»˜åˆ¶åŠ ç²—æ–‡æœ¬æ•ˆæœ
        function drawBoldText(ctx, x, y, text, font, fill) {
            ctx.font = font;
            ctx.fillStyle = fill;
            const offsets = [
                [-2, -2], [-2, -1], [-2, 0], [-2, 1], [-2, 2],
                [-1, -2], [-1, -1], [-1, 0], [-1, 1], [-1, 2],
                [0, -2], [0, -1], [0, 0], [0, 1], [0, 2],
                [1, -2], [1, -1], [1, 0], [1, 1], [1, 2],
                [2, -2], [2, -1], [2, 0], [2, 1], [2, 2]
            ];
            for (const [dx, dy] of offsets) {
                ctx.fillText(text, x + dx, y + dy);
            }
            ctx.fillStyle = fill;
            ctx.fillText(text, x, y);
        }

        // ç”Ÿæˆåˆæˆå›¾ç‰‡æ ¸å¿ƒé€»è¾‘
        async function generateCompositeImage(isPreview = false) {
            if (!resourcesLoaded) {
                throw new Error("èµ„æºå°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™...");
            }

            let resolution = getResolution();
            // å°å±æ‰‹æœºé¢„è§ˆæ—¶è‹¥é€‰äº† 1080P åˆ™é™çº§ï¼Œè‹¥é€‰äº† 4K åˆ™å°½é‡æ¸²æŸ“
            if (isPreview && window.innerWidth < 600 && elements.res1k.checked) {
                 resolution = { width: 1920, height: 1080 }; 
            }

            const canvas = document.createElement('canvas');
            canvas.width = 3840;
            canvas.height = 2160;
            const ctx = canvas.getContext('2d');

            // ç»˜åˆ¶èƒŒæ™¯
            const bgImg = new Image();
            bgImg.src = BACKGROUND_URL;
            bgImg.crossOrigin = "Anonymous";
            await new Promise((resolve, reject) => {
                bgImg.onload = resolve;
                bgImg.onerror = reject;
            });
            
            ctx.drawImage(bgImg, 0, 0, 3840, 2160);

            // è·å–è¾“å…¥å€¼ (é»˜è®¤å€¼ï¼šå¥¥æ–¯å¡æ™šå®´)
            const hallTime = elements.timeInput.value.trim() || "ä»€ä¹ˆå…æ™šå®´";
            const groom = elements.groomInput.value.trim() || "æ–°éƒ";
            const bride = elements.brideInput.value.trim() || "æ–°å¨˜";
            const weddingType = elements.typeInput.value.trim() || "æ²¡å†™å®´";
            const textColor = "rgba(120, 65, 25, 1)";

            // æ–‡å­—åæ ‡ (å·²ä¿®æ­£å‚ç›´åç§»)
            const positions = {
                groom: { x: 650, y: 1110 + 158 },
                bride: { x: 650, y: 1380 + 158 },
                time: { x: 280, y: 490 + 148 },
                type: { x: 3100, y: 100 + 167 }
            };

            const fonts = {
                groom: loadFont(192),
                bride: loadFont(192),
                time: loadFont(166),
                type: loadFont(220)
            };

            // ç»˜åˆ¶æ–‡å­—
            drawText(ctx, positions.groom.x, positions.groom.y, groom, fonts.groom, textColor);
            drawText(ctx, positions.bride.x, positions.bride.y, bride, fonts.bride, textColor);
            drawBoldText(ctx, positions.time.x, positions.time.y, hallTime, fonts.time, textColor);
            drawText(ctx, positions.type.x, positions.type.y, weddingType, fonts.type, textColor);

            // ç»˜åˆ¶ç”¨æˆ·å›¾ç‰‡
            if (userImageBase64) {
                try {
                    const userImg = new Image();
                    userImg.src = userImageBase64;
                    await new Promise(resolve => { userImg.onload = resolve; });
                    const processedImg = cropToTarget(userImg, 2544, 1760);
                    const x = 3840 - 2544;
                    const y = 2160 - 1760;
                    ctx.drawImage(processedImg, x, y);
                } catch (e) { console.error("å›¾ç‰‡å¤„ç†å¤±è´¥:", e); }
            }

            // ç¼©æ”¾è¾“å‡º
            if (resolution.width !== 3840 || resolution.height !== 2160) {
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = resolution.width;
                finalCanvas.height = resolution.height;
                const finalCtx = finalCanvas.getContext('2d');
                finalCtx.drawImage(canvas, 0, 0, resolution.width, resolution.height);
                return finalCanvas;
            }
            return canvas;
        }

        // æ›´æ–°é¢„è§ˆ
        async function updatePreview() {
            if (!resourcesLoaded) {
                elements.loadingMsg.style.display = 'block';
                return;
            }
            
            const previewCtx = elements.previewCanvas.getContext('2d');
            elements.previewCanvas.width = elements.previewCanvas.parentElement.clientWidth - 20;
            elements.previewCanvas.height = 200; 
            previewCtx.fillStyle = "#f0f0f0";
            previewCtx.fillRect(0,0, elements.previewCanvas.width, elements.previewCanvas.height);
            previewCtx.fillStyle = "#999";
            previewCtx.font = "14px Arial";
            previewCtx.textAlign = "center";
            previewCtx.fillText("ç”Ÿæˆä¸­...", elements.previewCanvas.width/2, 100);

            try {
                const composite = await generateCompositeImage(true);
                
                const previewWidth = elements.previewCanvas.parentElement.clientWidth - 20;
                const previewHeight = Math.floor(previewWidth * composite.height / composite.width);
                
                elements.previewCanvas.width = previewWidth;
                elements.previewCanvas.height = previewHeight;
                
                previewCtx.drawImage(composite, 0, 0, previewWidth, previewHeight);
            } catch (e) {
                console.error("é¢„è§ˆå‡ºé”™:", e);
                previewCtx.fillStyle = "red";
                previewCtx.fillText("å‡ºé”™ï¼š" + e.message, elements.previewCanvas.width/2, 100);
            }
        }

        // ç”Ÿæˆå¹¶ä¸‹è½½å›¾ç‰‡
        async function generateImage() {
            if (!resourcesLoaded) {
                alert("èµ„æºæ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•ï¼");
                return;
            }

            const originalText = elements.generateBtn.innerText;
            elements.generateBtn.innerText = "â³ ç”Ÿæˆä¸­...";
            elements.generateBtn.disabled = true;

            try {
                const composite = await generateCompositeImage(false);
                const format = elements.fmtJpg.checked ? 'image/jpeg' : 'image/png';
                
                composite.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const groomName = elements.groomInput.value.trim();
                    const brideName = elements.brideInput.value.trim();
                    
                    // âœ… æ–‡ä»¶åæ ¼å¼ï¼šæ–°éƒ æ–°å¨˜ (ä¸­é—´æœ‰ç©ºæ ¼)
                    let fileName = "wedding_invitation";
                    if (groomName && brideName) {
                        fileName = `${groomName} ${brideName}`;
                    } else if (groomName) {
                        fileName = groomName;
                    } else if (brideName) {
                        fileName = brideName;
                    }
                    
                    const extension = format === 'image/jpeg' ? 'jpg' : 'png';
                    
                    a.download = `${fileName}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`âœ… å›¾ç‰‡å·²ä¿å­˜ä¸ºï¼š${fileName}.${extension}`);
                }, format, format === 'image/jpeg' ? 0.95 : undefined);
            } catch (e) {
                console.error("å¯¼å‡ºå¤±è´¥:", e);
                alert("âŒ å¯¼å‡ºå¤±è´¥ï¼š" + e.message);
            } finally {
                elements.generateBtn.innerText = originalText;
                elements.generateBtn.disabled = false;
            }
        }

        // ================= åˆå§‹åŒ–åº”ç”¨ =================
        async function initApp() {
            // âœ… å¼ºåˆ¶é»˜è®¤é€‰ä¸­ 4K
            elements.res4k.checked = true;
            elements.res1k.checked = false;

            // åŠ è½½å­—ä½“å’Œèµ„æº
            customFontFamily = await loadCustomFont();
            initEventListeners();
            
            await preloadResources();
            
            // åˆå§‹æ¸²æŸ“
            updatePreview();
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>


