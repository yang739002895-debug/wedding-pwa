<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½è³å¨æ±€æ°´å°</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f5f5f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .version-tag {
            font-size: 0.8rem;
            background: #e9ecef;
            color: #6c757d;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: normal;
        }

        .form-group { margin-bottom: 12px; }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-label {
            width: 90px;
            text-align: right;
            margin-right: 10px;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        
        /* é€šç”¨è¾“å…¥æ¡† */
        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 200px;
        }

        /* âœ… æ–°å¢ï¼šå§“åä¸“ç”¨è¾“å…¥æ¡†ç»„ (ç¼©å°å®½åº¦ + åŠ å‡æŒ‰é’®) */
        .name-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 200px;
        }
        .name-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%; /* å æ»¡å‰©ä½™ç©ºé—´ */
        }
        .size-btn {
            width: 32px;
            height: 38px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .size-btn:active { background: #e2e6ea; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 1rem;
            flex: 1;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* ä¿®å¤é€‰å›¾æŒ‰é’® */
        .photo-btn-fixed {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 150px;
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        @media (max-width: 600px) {
            .form-row { flex-direction: column; align-items: stretch; }
            .form-label { width: 100%; text-align: left; margin-bottom: 5px; font-weight: bold;}
            .form-input, .name-input-group { width: 100%; box-sizing: border-box; }
            .btn { width: 100%; margin-right: 0; }
            .radio-group { flex-direction: column; gap: 8px; }
        }

        .preview-container {
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 15px;
            text-align: center;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-image { max-width: 100%; height: auto; display: block; }

        /* æ§åˆ¶ç»„é€šç”¨æ ·å¼ */
        .control-group {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            display: none;
        }
        .control-group h4 {
            margin-top: 0;
            font-size: 1rem;
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin: 12px 0;
        }
        .slider-label {
            width: 50px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            flex-shrink: 0;
        }
        .slider-wrapper { flex: 1; margin: 0 10px; }
        input[type=range] { width: 100%; height: 25px; }

        .export-options {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .radio-group { display: flex; gap: 15px; margin-top: 8px; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; font-size: 0.95rem; }
        .radio-item input { margin-right: 6px; transform: scale(1.2); }
        
        .file-info { margin-left: 10px; color: #666; font-size: 0.9rem; word-break: break-all; line-height: 40px; }
        .hidden { display: none; }
        .loading-tip {
            color: #999; font-size: 0.9rem; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 10;
        }
        .size-display {
            font-size: 0.8rem; color: #666; width: 35px; text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 5. æ ‡é¢˜ååŠ ç‰ˆæœ¬å· -->
        <h1>
            å¥½è³å¨æ±€æ°´å° 
            <span class="version-tag">v1.0</span>
        </h1>
        
        <!-- è¾“å…¥å­—æ®µ -->
        <div class="form-group">
            <div class="form-row">
                <label class="form-label">å…æ—¶æ®µ:</label>
                <input type="text" id="timeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¥¥æ–¯å¡æ™šå®´">
            </div>
            
            <!-- 4. ç¼©å°è¾“å…¥æ¡† + åŠ å‡å· + 6. ä¿®æ”¹æç¤ºè¯ -->
            <div class="form-row">
                <label class="form-label">æ–°éƒå§“å:</label>
                <div class="name-input-group">
                    <input type="text" id="groomInput" class="name-input" placeholder="ä¾‹å¦‚ï¼šâ€œæ–°éƒï¼šå¼ ä¸‰ æˆ– â€œèµµä¸€é¸£â€">
                    <div class="size-btn" id="groomMinus" title="ç¼©å°">âˆ’</div>
                    <div class="size-display" id="groomSizeDisplay">100%</div>
                    <div class="size-btn" id="groomPlus" title="æ”¾å¤§">+</div>
                </div>
            </div>
            
            <div class="form-row">
                <label class="form-label">æ–°å¨˜å§“å:</label>
                <div class="name-input-group">
                    <input type="text" id="brideInput" class="name-input" placeholder="ä¾‹å¦‚ï¼šâ€æ–°å¨˜ï¼šæå››â€œ æˆ– ä¸è¾“å…¥">
                    <div class="size-btn" id="brideMinus" title="ç¼©å°">âˆ’</div>
                    <div class="size-display" id="brideSizeDisplay">100%</div>
                    <div class="size-btn" id="bridePlus" title="æ”¾å¤§">+</div>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">å®´å¸­ç±»å‹:</label>
                <input type="text" id="typeInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šå©šå®´">
            </div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="form-group">
            <div class="form-row" style="flex-direction: row; align-items: center;">
                <button id="photoBtn" class="btn btn-primary photo-btn-fixed">ğŸ–¼ï¸ é€‰å›¾</button>
                <span id="photoInfo" class="file-info">æœªé€‰æ‹©</span>
                <input type="file" id="photoFile" accept="image/*" class="hidden">
            </div>
        </div>

        <!-- å›¾ç‰‡è£å‰ªæ§åˆ¶ -->
        <div id="cropControls" class="control-group">
            <h4>ğŸ“· ç”¨æˆ·å›¾ç‰‡ä½ç½®è°ƒæ•´</h4>
            <div class="slider-container">
                <span class="slider-label">å·¦å³</span>
                <div class="slider-wrapper">
                    <input type="range" id="hSlider" min="-500" max="500" value="0" step="25">
                </div>
            </div>
            <div class="slider-container">
                <span class="slider-label">ä¸Šä¸‹</span>
                <div class="slider-wrapper">
                    <input type="range" id="vSlider" min="-500" max="500" value="0" step="25">
                </div>
            </div>
        </div>

        <!-- 4. æ–°å¢ï¼šæ–°éƒæ–°å¨˜ä½ç½®ä¸å¤§å°æ§åˆ¶ -->
        <div id="nameControls" class="control-group">
            <h4>âœï¸ æ–°äººå§“åä½ç½®è°ƒæ•´</h4>
            <div class="slider-container">
                <span class="slider-label">å·¦å³</span>
                <div class="slider-wrapper">
                    <input type="range" id="nameHSlider" min="-1000" max="1000" value="0" step="10">
                </div>
            </div>
            <div class="slider-container">
                <span class="slider-label">ä¸Šä¸‹</span>
                <div class="slider-wrapper">
                    <input type="range" id="nameVSlider" min="-1000" max="1000" value="0" step="10">
                </div>
            </div>
            <div style="text-align: center; font-size: 0.8rem; color: #999; margin-top:5px;">
                æ‹–åŠ¨æ»‘å—è°ƒæ•´ä¸¤äººå§“åçš„æ•´ä½“ä½ç½®
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-container">
            <canvas id="previewCanvas" class="preview-image"></canvas>
            <div id="loadingMsg" class="loading-tip" style="display:none;">æ­£åœ¨åŠ è½½èµ„æº...</div>
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <button id="refreshBtn" class="btn btn-warning">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
        </div>

        <!-- å¯¼å‡ºè®¾ç½® -->
        <div class="export-options">
            <h3 style="font-size: 1rem; margin-top:0; color:#444;">å¯¼å‡ºè®¾ç½®</h3>
            <div class="form-row" style="flex-direction: column; align-items: flex-start;">
                <label style="font-weight:bold; font-size:0.9rem;">åˆ†è¾¨ç‡:</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="resolution" id="res4k" value="4k" checked> 4K (3840Ã—2160)
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="resolution" id="res1k" value="1k"> 1080P
                    </label>
                </div>
            </div>
            <div class="form-row" style="flex-direction: column; align-items: flex-start; margin-top:10px;">
                <label style="font-weight:bold; font-size:0.9rem;">æ ¼å¼:</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="format" id="fmtJpg" value="jpg" checked> JPG
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="format" id="fmtPng" value="png"> PNG
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button id="generateBtn" class="btn btn-success" style="font-size: 1.1rem; font-weight: bold;">ğŸ’¾ ç”Ÿæˆå¹¶ä¿å­˜å›¾ç‰‡</button>
        </div>
    </div>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('âœ… SW OK:', reg.scope))
                    .catch(err => console.error('âŒ SW Fail:', err));
            });
        }
    </script>

    <script>
        // ================= é…ç½®åŒº =================
        const BACKGROUND_URL = "./back.png"; 
        const FONT_URL = "./FZXiaoBiaoSong-B05S.woff2";
        const BASE_FONT_SIZE = 192; // åŸºç¡€å­—å·
        
        // çŠ¶æ€å˜é‡
        let userImageBase64 = null;
        let cropOffsetX = 0;
        let cropOffsetY = 0;
        
        // å§“åæ§åˆ¶å˜é‡
        let nameOffsetX = 0;
        let nameOffsetY = 0;
        let groomScale = 100; // ç™¾åˆ†æ¯”
        let brideScale = 100; // ç™¾åˆ†æ¯”

        let customFontFamily = 'serif';
        let resourcesLoaded = false;

        // DOM å…ƒç´ 
        const elements = {
            timeInput: document.getElementById('timeInput'),
            groomInput: document.getElementById('groomInput'),
            brideInput: document.getElementById('brideInput'),
            typeInput: document.getElementById('typeInput'),
            photoBtn: document.getElementById('photoBtn'),
            photoFile: document.getElementById('photoFile'),
            photoInfo: document.getElementById('photoInfo'),
            cropControls: document.getElementById('cropControls'),
            hSlider: document.getElementById('hSlider'),
            vSlider: document.getElementById('vSlider'),
            
            // å§“åæ§åˆ¶
            nameControls: document.getElementById('nameControls'),
            nameHSlider: document.getElementById('nameHSlider'),
            nameVSlider: document.getElementById('nameVSlider'),
            groomMinus: document.getElementById('groomMinus'),
            groomPlus: document.getElementById('groomPlus'),
            groomSizeDisplay: document.getElementById('groomSizeDisplay'),
            brideMinus: document.getElementById('brideMinus'),
            bridePlus: document.getElementById('bridePlus'),
            brideSizeDisplay: document.getElementById('brideSizeDisplay'),

            previewCanvas: document.getElementById('previewCanvas'),
            refreshBtn: document.getElementById('refreshBtn'),
            res4k: document.getElementById('res4k'),
            res1k: document.getElementById('res1k'),
            fmtJpg: document.getElementById('fmtJpg'),
            fmtPng: document.getElementById('fmtPng'),
            generateBtn: document.getElementById('generateBtn'),
            loadingMsg: document.getElementById('loadingMsg')
        };

        // åŠ è½½å­—ä½“
        async function loadCustomFont() {
            if (!FONT_URL) return 'serif';
            const fontName = 'FZXiaoBiaoSong';
            const style = document.createElement('style');
            style.textContent = `@font-face { font-family: "${fontName}"; src: url('${FONT_URL}') format("woff2"); }`;
            document.head.appendChild(style);
            try {
                await document.fonts.load(`${BASE_FONT_SIZE}px "${fontName}"`);
                return fontName;
            } catch (e) { return 'serif'; }
        }

        // é¢„åŠ è½½
        async function preloadResources() {
            elements.loadingMsg.style.display = 'block';
            try {
                customFontFamily = await loadCustomFont();
                const bgImg = new Image();
                bgImg.src = BACKGROUND_URL;
                await new Promise((resolve, reject) => {
                    bgImg.onload = resolve;
                    bgImg.onerror = () => reject(new Error("èƒŒæ™¯å›¾å¤±è´¥"));
                });
                resourcesLoaded = true;
                elements.loadingMsg.style.display = 'none';
            } catch (e) {
                elements.loadingMsg.textContent = "èµ„æºåŠ è½½å¤±è´¥";
                elements.loadingMsg.style.color = "red";
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶
        function initEventListeners() {
            elements.photoBtn.addEventListener('click', () => elements.photoFile.click());
            elements.photoFile.addEventListener('change', handlePhotoUpload);
            
            // å›¾ç‰‡æ»‘å—
            elements.hSlider.addEventListener('input', (e) => { cropOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.vSlider.addEventListener('input', (e) => { cropOffsetY = parseInt(e.target.value); updatePreview(); });

            // å§“åæ»‘å—
            elements.nameHSlider.addEventListener('input', (e) => { nameOffsetX = parseInt(e.target.value); updatePreview(); });
            elements.nameVSlider.addEventListener('input', (e) => { nameOffsetY = parseInt(e.target.value); updatePreview(); });

            // 4. åŠ å‡å·äº‹ä»¶
            elements.groomPlus.addEventListener('click', () => { groomScale = Math.min(groomScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.groomMinus.addEventListener('click', () => { groomScale = Math.max(groomScale - 10, 20); updateSizeUI(); updatePreview(); });
            elements.bridePlus.addEventListener('click', () => { brideScale = Math.min(brideScale + 10, 300); updateSizeUI(); updatePreview(); });
            elements.brideMinus.addEventListener('click', () => { brideScale = Math.max(brideScale - 10, 20); updateSizeUI(); updatePreview(); });

            elements.refreshBtn.addEventListener('click', updatePreview);
            elements.generateBtn.addEventListener('click', generateImage);
            
            [elements.timeInput, elements.groomInput, elements.brideInput, elements.typeInput].forEach(input => {
                input.addEventListener('input', updatePreview);
            });
        }

        function updateSizeUI() {
            elements.groomSizeDisplay.textContent = groomScale + '%';
            elements.brideSizeDisplay.textContent = brideScale + '%';
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                userImageBase64 = e.target.result;
                elements.photoInfo.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                elements.cropControls.style.display = 'block';
                checkNameControls();
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function checkNameControls() {
            const hasGroom = elements.groomInput.value.trim();
            const hasBride = elements.brideInput.value.trim();
            if (hasGroom || hasBride) {
                elements.nameControls.style.display = 'block';
            } else {
                elements.nameControls.style.display = 'none';
            }
        }

        function getResolution() {
            if (elements.res4k.checked) return { width: 3840, height: 2160 };
            return { width: 1920, height: 1080 };
        }

        function loadFont(size) {
            return `${size}px "${customFontFamily}"`;
        }

        function cropToTarget(img, targetW = 2544, targetH = 1760) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const targetRatio = targetW / targetH;
            const origRatio = img.width / img.height;
            let newW, newH;
            if (origRatio > targetRatio) {
                newH = targetH; newW = newH * origRatio;
            } else {
                newW = targetW; newH = newW / origRatio;
            }
            canvas.width = newW; canvas.height = newH;
            ctx.drawImage(img, 0, 0, newW, newH);
            let left = (newW - targetW) / 2;
            let top = (newH - targetH) / 2;
            left = Math.max(0, Math.min(left + cropOffsetX, newW - targetW));
            top = Math.max(0, Math.min(top + cropOffsetY, newH - targetH));
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = targetW; cropCanvas.height = targetH;
            const cropCtx = cropCanvas.getContext('2d');
            cropCtx.drawImage(canvas, left, top, targetW, targetH, 0, 0, targetW, targetH);
            return cropCanvas;
        }

        function drawText(ctx, x, y, text, font, fill) {
            ctx.font = font;
            ctx.fillStyle = fill;
            ctx.fillText(text, x, y);
        }

        function drawBoldText(ctx, x, y, text, font, fill) {
            ctx.font = font;
            ctx.fillStyle = fill;
            const offsets = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            for (const [dx, dy] of offsets) ctx.fillText(text, x+dx, y+dy);
            ctx.fillText(text, x, y);
        }

        async function generateCompositeImage(isPreview = false) {
            if (!resourcesLoaded) throw new Error("èµ„æºæœªåŠ è½½");
            let resolution = getResolution();
            if (isPreview && window.innerWidth < 600 && elements.res1k.checked) resolution = { width: 1920, height: 1080 };

            const canvas = document.createElement('canvas');
            canvas.width = 3840; canvas.height = 2160;
            const ctx = canvas.getContext('2d');

            const bgImg = new Image();
            bgImg.src = BACKGROUND_URL;
            bgImg.crossOrigin = "Anonymous";
            await new Promise((resolve, reject) => { bgImg.onload = resolve; bgImg.onerror = reject; });
            ctx.drawImage(bgImg, 0, 0, 3840, 2160);

            // 2. è·å–å€¼ï¼Œç©ºåˆ™ä¸æ˜¾ç¤º
            const hallTime = elements.timeInput.value.trim() || "ä»€ä¹ˆå…æ™šå®´";
            const groom = elements.groomInput.value.trim();
            const bride = elements.brideInput.value.trim();
            const weddingType = elements.typeInput.value.trim() || "æ²¡å†™å®´";
            const textColor = "rgba(120, 65, 25, 1)";

            // 1. åŸºç¡€åæ ‡ (åŸ X=650, ç°åœ¨å‘å·¦ç§» 536 -> 114)
            const baseX = 650 - 536; 
            const baseGroomY = 1110 + 158;
            const baseBrideY = 1380 + 158;
            const baseTimeX = 280, baseTimeY = 490 + 148;
            const baseTypeX = 3100, baseTypeY = 100 + 167;

            // åº”ç”¨æ»‘å—åç§»
            const finalX = baseX + nameOffsetX;
            let finalGroomY = baseGroomY + nameOffsetY;
            let finalBrideY = baseBrideY + nameOffsetY;

            // 3. å•äººè¡Œé€»è¾‘ï¼šæœ‰æ–°éƒæ— æ–°å¨˜ï¼Œæ–°éƒä¸‹ç§» 120
            if (groom && !bride) {
                finalGroomY += 120;
            }

            // ç»˜åˆ¶å…¶ä»–æ–‡å­—
            if (hallTime) drawBoldText(ctx, baseTimeX, baseTimeY, hallTime, loadFont(166), textColor);
            if (weddingType) drawText(ctx, baseTypeX, baseTypeY, weddingType, loadFont(220), textColor);

            // ç»˜åˆ¶å§“å (å¸¦ç¼©æ”¾)
            if (groom) {
                const size = BASE_FONT_SIZE * (groomScale / 100);
                drawText(ctx, finalX, finalGroomY, groom, loadFont(size), textColor);
            }
            if (bride) {
                const size = BASE_FONT_SIZE * (brideScale / 100);
                drawText(ctx, finalX, finalBrideY, bride, loadFont(size), textColor);
            }

            if (userImageBase64) {
                try {
                    const userImg = new Image();
                    userImg.src = userImageBase64;
                    await new Promise(r => { userImg.onload = r; });
                    const processedImg = cropToTarget(userImg, 2544, 1760);
                    ctx.drawImage(processedImg, 3840 - 2544, 2160 - 1760);
                } catch (e) { console.error(e); }
            }

            if (resolution.width !== 3840 || resolution.height !== 2160) {
                const fC = document.createElement('canvas');
                fC.width = resolution.width; fC.height = resolution.height;
                fC.getContext('2d').drawImage(canvas, 0, 0, resolution.width, resolution.height);
                return fC;
            }
            return canvas;
        }

        async function updatePreview() {
            if (!resourcesLoaded) return;
            const pCtx = elements.previewCanvas.getContext('2d');
            elements.previewCanvas.width = elements.previewCanvas.parentElement.clientWidth - 20;
            elements.previewCanvas.height = 200;
            pCtx.fillStyle = "#f0f0f0";
            pCtx.fillRect(0,0, elements.previewCanvas.width, elements.previewCanvas.height);
            pCtx.fillStyle = "#999"; pCtx.font = "14px Arial"; pCtx.textAlign = "center";
            pCtx.fillText("ç”Ÿæˆä¸­...", elements.previewCanvas.width/2, 100);

            try {
                const composite = await generateCompositeImage(true);
                const w = elements.previewCanvas.parentElement.clientWidth - 20;
                const h = Math.floor(w * composite.height / composite.width);
                elements.previewCanvas.width = w; elements.previewCanvas.height = h;
                pCtx.drawImage(composite, 0, 0, w, h);
                checkNameControls();
            } catch (e) {
                pCtx.fillStyle = "red"; pCtx.fillText("å‡ºé”™", w/2, 100);
            }
        }

        async function generateImage() {
            if (!resourcesLoaded) { alert("åŠ è½½ä¸­..."); return; }
            const oldTxt = elements.generateBtn.innerText;
            elements.generateBtn.innerText = "â³...";
            elements.generateBtn.disabled = true;
            try {
                const composite = await generateCompositeImage(false);
                const fmt = elements.fmtJpg.checked ? 'image/jpeg' : 'image/png';
                composite.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const g = elements.groomInput.value.trim();
                    const b = elements.brideInput.value.trim();
                    let name = "wedding";
                    if (g && b) name = `${g} ${b}`;
                    else if (g) name = g;
                    else if (b) name = b;
                    a.download = `${name}.${fmt === 'image/jpeg' ? 'jpg' : 'png'}`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`âœ… å·²ä¿å­˜ï¼š${a.download}`);
                }, fmt, 0.95);
            } catch (e) { alert("âŒ " + e.message); }
            finally { elements.generateBtn.innerText = oldTxt; elements.generateBtn.disabled = false; }
        }

        async function initApp() {
            elements.res4k.checked = true;
            customFontFamily = await loadCustomFont();
            initEventListeners();
            await preloadResources();
            updatePreview();
        }
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

